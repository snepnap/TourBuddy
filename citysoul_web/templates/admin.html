<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TourBuddy Admin Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --surface: #1e293b; --accent: #2dd4bf; --text: #f1f5f9; --border: #334155; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        h1 { margin: 0; color: var(--accent); }
        .btn-nav { background: var(--surface); color: white; border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; cursor: pointer; }
        .btn-nav:hover { border-color: var(--accent); color: var(--accent); }

        /* Stats Section */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-num { font-size: 2.5rem; font-weight: 800; color: var(--accent); margin: 5px 0; }
        .stat-label { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Management Section */
        .section-title { font-size: 1.5rem; margin-bottom: 15px; border-left: 4px solid var(--accent); padding-left: 10px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        select { background: var(--bg); color: white; border: 1px solid var(--border); padding: 10px; border-radius: 8px; flex: 1; }
        .btn-load { background: var(--accent); color: var(--bg); border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Items Grid */
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .item-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; position: relative; }
        .item-img { width: 100%; height: 140px; object-fit: cover; }
        .item-body { padding: 15px; }
        .item-body h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .item-actions { display: flex; gap: 5px; margin-top: 10px; }
        .btn-action { flex: 1; padding: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        .btn-edit { background: #fbbf24; color: black; }
        .btn-del { background: #ef4444; color: white; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--surface); width: 90%; max-width: 500px; padding: 25px; border-radius: 15px; border: 1px solid var(--border); position: relative; }
        .inp-group { margin-bottom: 10px; }
        .inp-group label { display: block; color: #94a3b8; font-size: 0.8rem; margin-bottom: 4px; }
        .inp { width: 100%; background: var(--bg); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; box-sizing: border-box; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Admin Dashboard üõ°Ô∏è</h1>
            <div style="display:flex; gap:10px;">
                <a href="/" class="btn-nav">View Site</a>
                <a href="javascript:logout()" class="btn-nav" style="border-color:#ef4444; color:#ef4444;">Logout</a>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Total Users</div><div class="stat-num" id="uCount">--</div></div>
            <div class="stat-card"><div class="stat-label">Total Places</div><div class="stat-num" id="pCount">--</div></div>
            <div class="stat-card"><div class="stat-label">Reviews</div><div class="stat-num" id="rCount">--</div></div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:40px;">
            <div class="stat-card" style="height:300px;"><canvas id="catChart"></canvas></div>
            <div class="stat-card" style="height:300px;"><canvas id="cityChart"></canvas></div>
        </div>

        <h2 class="section-title">Manage Content</h2>
        <div class="controls">
            <select id="citySelect"><option>Loading Cities...</option></select>
            <select id="categorySelect">
                <option value="places">Places</option>
                <option value="food">Food</option>
                <option value="shopping">Shopping</option>
                <option value="hotels">Hotels</option>
            </select>
            <button class="btn-load" onclick="loadItems()">Load Items</button>
        </div>

        <div id="itemsContainer" class="items-grid"></div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeEditModal()">√ó</button>
            <h2 style="color:var(--accent); margin-top:0;">Edit Item</h2>
            <form id="editForm">
                <div class="inp-group"><label>Name</label><input id="editName" class="inp"></div>
                <div class="inp-group"><label>Description</label><textarea id="editDesc" class="inp" rows="3"></textarea></div>
                <div style="display:flex; gap:10px;">
                    <div class="inp-group" style="flex:1"><label>Rating</label><input id="editRating" class="inp"></div>
                    <div class="inp-group" style="flex:1"><label>Budget</label><input id="editBudget" class="inp"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="inp-group" style="flex:1"><label>Lat</label><input id="editLat" class="inp"></div>
                    <div class="inp-group" style="flex:1"><label>Lon</label><input id="editLon" class="inp"></div>
                </div>
                <div class="inp-group"><label>Change Image</label><input type="file" id="editImageFile" class="inp"></div>
                <button type="submit" class="btn-load" style="width:100%; margin-top:10px;">SAVE CHANGES</button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. AUTH & STATS ---
        const token = localStorage.getItem('tok');
        const role = localStorage.getItem('role');
        if (!token || role !== 'admin') { alert("Admins Only"); window.location.href = "/"; }

        function logout() { localStorage.clear(); window.location.href = "/"; }

        // Load Stats
        async function loadStats() {
            try {
                const res = await fetch('/admin_stats');
                const d = await res.json();
                if(d.status === 'success'){
                    document.getElementById('uCount').innerText = d.counts[0];
                    document.getElementById('pCount').innerText = d.counts[1];
                    document.getElementById('rCount').innerText = d.counts[2];
                    
                    new Chart(document.getElementById('catChart'), {
                        type: 'doughnut',
                        data: { labels: d.cat_labels, datasets: [{ data: d.cat_values, backgroundColor: ['#2dd4bf','#facc15','#f87171','#a78bfa'] }] },
                        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{color:'white'}}} }
                    });
                    new Chart(document.getElementById('cityChart'), {
                        type: 'bar',
                        data: { labels: d.city_labels, datasets: [{ label:'Places', data: d.city_values, backgroundColor: '#2dd4bf', borderRadius:4 }] },
                        options: { responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, ticks:{color:'white'}}, x:{ticks:{color:'white'}}} }
                    });
                }
            } catch(e) {}
        }
        loadStats();

        // --- 2. CONTENT MANAGER LOGIC ---
        let currentEditId = null;

        async function initCMS() {
            // Load Cities
            const r = await fetch('/api/cities');
            const cities = await r.json();
            const sel = document.getElementById('citySelect');
            sel.innerHTML = '<option value="">Select City</option>';
            cities.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.innerText = c.toUpperCase();
                sel.appendChild(opt);
            });
        }
        initCMS();

        async function loadItems() {
            const city = document.getElementById('citySelect').value;
            const cat = document.getElementById('categorySelect').value;
            if(!city) return alert("Select a city");
            
            const cont = document.getElementById('itemsContainer');
            cont.innerHTML = '<p>Loading...</p>';
            
            const r = await fetch(`/admin/api/items/${city}/${cat}?token=${token}`);
            const items = await r.json();
            
            cont.innerHTML = '';
            if(items.length === 0) cont.innerHTML = '<p>No items found.</p>';
            
            items.forEach(i => {
                const d = document.createElement('div');
                d.className = 'item-card';
                d.innerHTML = `
                    <img src="${i.img}" class="item-img">
                    <div class="item-body">
                        <h3>${i.name}</h3>
                        <p style="color:#94a3b8; font-size:0.8rem;">${i.desc.substring(0,50)}...</p>
                        <div class="item-actions">
                            <button class="btn-action btn-edit" onclick='openEdit(${JSON.stringify(i).replace(/'/g, "&#39;")})'>EDIT</button>
                            <button class="btn-action btn-del" onclick="delItem('${i.id}')">DELETE</button>
                        </div>
                    </div>
                `;
                cont.appendChild(d);
            });
        }

        // --- 3. EDIT LOGIC ---
        function openEdit(item) {
            currentEditId = item.id;
            document.getElementById('editName').value = item.name;
            document.getElementById('editDesc').value = item.desc;
            document.getElementById('editRating').value = item.rating || "0";
            document.getElementById('editBudget').value = item.budget;
            document.getElementById('editLat').value = item.lat;
            document.getElementById('editLon').value = item.lon;
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            const city = document.getElementById('citySelect').value;
            const cat = document.getElementById('categorySelect').value;
            
            const fd = new FormData();
            fd.append('name', document.getElementById('editName').value);
            fd.append('desc', document.getElementById('editDesc').value);
            fd.append('rating', document.getElementById('editRating').value);
            fd.append('budget', document.getElementById('editBudget').value);
            fd.append('lat', document.getElementById('editLat').value);
            fd.append('lon', document.getElementById('editLon').value);
            fd.append('token', token);
            
            await fetch(`/admin/api/edit/${city}/${cat}/${currentEditId}`, { method:'POST', body:fd });
            
            // Handle Image Upload
            const f = document.getElementById('editImageFile').files[0];
            if(f) {
                const reader = new FileReader();
                reader.readAsDataURL(f);
                reader.onload = async () => {
                    const b64 = reader.result.split(',')[1];
                    const fd2 = new FormData();
                    fd2.append('token', token); fd2.append('img_data', b64);
                    await fetch(`/admin/api/upload/${city}/${cat}/${currentEditId}`, { method:'POST', body:fd2 });
                    alert("Saved & Uploaded!");
                    closeEditModal(); loadItems();
                }
            } else {
                alert("Saved!");
                closeEditModal(); loadItems();
            }
        };

        async function delItem(id) {
            if(!confirm("Delete this?")) return;
            const fd = new FormData(); fd.append('id', id); fd.append('token', token);
            await fetch('/admin_delete', { method:'POST', body:fd });
            loadItems();
        }
    </script>
</body>
</html>