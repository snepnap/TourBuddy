<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourBuddy AI v7.5 (Final Fixed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>
    <style>
        /* Dark Theme (Default) */
        :root { --bg:#020617; --surface:#0f172a; --accent:#2dd4bf; --text:#f1f5f9; --border:#334155; }
        
        /* Light Theme */
        [data-theme="light"] {
            --bg: #f8fafc; --surface: #ffffff; --accent: #0d9488; --text: #0f172a; --border: #cbd5e1;
        }

        body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text); margin:0; transition: background 0.3s, color 0.3s; }
        
        /* Navbar */
        .navbar { position:fixed; top:20px; left:5%; width:90%; background:var(--surface); box-shadow:0 4px 20px rgba(0,0,0,0.1); border:1px solid var(--border); border-radius:50px; padding:10px 30px; display:flex; justify-content:space-between; align-items:center; z-index:1000; }
        .logo { font-size:1.5rem; font-weight:800; } .logo span { color:var(--accent); }
        .nav-btn { background:transparent; color:var(--text); padding:8px 15px; border-radius:30px; cursor:pointer; border:1px solid var(--border); text-decoration:none; display:flex; align-items:center; justify-content:center; }
        .nav-btn:hover { background:var(--accent); color:white; border-color:var(--accent); }

        /* Hero */
        .hero { text-align:center; margin-top:140px; }
        .search-box { background:var(--surface); padding:8px; border-radius:50px; display:inline-flex; width:500px; margin-top:30px; border:1px solid var(--border); box-shadow:0 4px 15px rgba(0,0,0,0.05); }
        .search-box input { background:transparent; border:none; color:var(--text); padding:10px 20px; flex:1; outline:none; font-size:1.1rem; }
        
        /* Tabs */
        .container { max-width:1200px; margin:0 auto; padding:0 5%; }
        .tabs { display:flex; justify-content:center; gap:10px; margin:30px 0; }
        .tab { padding:8px 20px; border-radius:30px; background:var(--surface); border:1px solid var(--border); color:var(--text); opacity:0.7; cursor:pointer; transition:0.3s; }
        .tab.active, .tab:hover { opacity:1; border-color:var(--accent); color:var(--accent); font-weight:bold; }

        /* Grid */
        .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:25px; padding-bottom:50px; }
        .card { background:var(--surface); border-radius:20px; overflow:hidden; border:1px solid var(--border); position:relative; display:flex; flex-direction:column; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
        .card-img { width:100%; height:200px; object-fit:cover; background:#222; }
        .card-body { padding:20px; flex:1; display:flex; flex-direction:column; }
        .vibe-badge { position:absolute; top:15px; left:15px; background:var(--accent); color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.3); padding:5px 12px; border-radius:15px; font-size:0.8rem; font-weight:bold; }
        
        /* Badges */
        .time-badge { display:inline-block; background:rgba(128,128,128,0.1); border:1px solid var(--border); color:var(--text); padding:2px 8px; border-radius:4px; font-size:0.8rem; margin-top:5px; }

        /* Buttons */
        .btn-group { display:flex; gap:5px; margin-top:auto; padding-top:15px; }
        .btn-sm { flex:1; padding:8px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer; font-size:0.8rem; transition:0.2s; }
        .btn-sm:hover { background:var(--accent); color:white; border-color:var(--accent); }
        .btn-nav { background:#3b82f6; color:white; border:none; } 

        /* Modals */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .modal { background:var(--surface); width:90%; max-width:500px; padding:30px; border-radius:30px; border:1px solid var(--border); position:relative; max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); }
        .input-field { width:100%; padding:12px; background:transparent; border:1px solid var(--border); color:var(--text); border-radius:10px; margin-top:10px; box-sizing:border-box; }
        .ai-btn { background:linear-gradient(45deg, #a78bfa, #2dd4bf); color:white; border:none; padding:5px 10px; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:bold; margin-top:5px; float:right; }
        .action-btn { width:100%; padding:12px; margin-top:20px; border-radius:40px; background:var(--accent); color:white; border:none; font-weight:bold; cursor:pointer; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo">TOUR<span>BUDDY</span></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="nav-btn" onclick="toggleTheme()" id="themeBtn" style="font-size:1.2rem; border:none;">‚òÄ</button>
            <a href="/admin" id="adminBtn" class="nav-btn" style="display:none; color:#f87171;">üõ°Ô∏è Admin</a>
            <div id="authBtn" class="nav-btn" onclick="openAuth()">Login</div>
        </div>
    </div>

    <div class="hero">
        <h1 id="heroCity">BILASPUR</h1>
        <div class="search-box">
            <input type="text" id="cityInput" value="Bilaspur">
            <button class="nav-btn" style="background:var(--accent); color:white; border:none;" onclick="fetchData()">GO</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('places', this)">Places</button>
            <button class="tab" onclick="switchTab('shopping', this)">Shop</button>
            <button class="tab" onclick="switchTab('food', this)">Food</button>
            <button class="tab" onclick="switchTab('hotels', this)">Stays</button>
        </div>
        <div class="grid" id="grid"></div>
    </div>

    <div onclick="openAdd()" style="position:fixed; bottom:30px; right:30px; width:60px; height:60px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; color:white; cursor:pointer; z-index:1500; font-weight:bold; box-shadow:0 5px 20px rgba(0,0,0,0.3);">+</div>

    <div id="addModal" class="modal-overlay">
        <div class="modal">
            <span onclick="document.getElementById('addModal').style.display='none'" style="position:absolute; top:20px; right:20px; cursor:pointer;">‚úï</span>
            <h2>Add Spot üåç</h2>
            <input id="aName" placeholder="Name (e.g. Taj Mahal)" class="input-field">
            
            <div style="display:flex; gap:10px;">
                <input id="aVibe" placeholder="Vibe (e.g. Chill)" class="input-field">
                <input id="aTime" placeholder="Avg Time (e.g. 2 hrs)" class="input-field">
            </div>

            <select id="aType" class="input-field" style="background:var(--surface); color:var(--text);">
                <option value="places">Place</option>
                <option value="food">Food</option>
                <option value="shopping">Shop</option>
                <option value="hotels">Hotel</option>
            </select>

            <div style="margin-top:10px;">
                <label style="color:#94a3b8; font-size:0.9rem;">Description</label>
                <button class="ai-btn" onclick="generateAI()">‚ú® Write with AI</button>
                <textarea id="aDesc" rows="3" class="input-field" placeholder="Or type manually..."></textarea>
            </div>

            <input id="aBudget" placeholder="Budget (e.g. $10)" class="input-field">
            <div style="display:flex; gap:5px;">
                <button onclick="findCoords()" class="input-field" style="background:var(--border); cursor:pointer;">üìç Find GPS</button>
                <input id="aLat" placeholder="Lat" class="input-field" style="width:30%">
                <input id="aLon" placeholder="Lon" class="input-field" style="width:30%">
            </div>

            <input type="file" id="aFile" class="input-field">
            <button onclick="subPlace()" class="action-btn">SUBMIT SPOT</button>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal">
            <span onclick="document.getElementById('detailModal').style.display='none'" style="position:absolute; top:20px; right:20px; cursor:pointer;">‚úï</span>
            <h2 id="detName" style="color:var(--accent)"></h2>
            <img id="detImg" style="width:100%; height:200px; object-fit:cover; border-radius:15px; margin:10px 0;">
            <p id="detDesc" style="color:var(--text); opacity:0.8; line-height:1.6;"></p>
            <div style="display:flex; justify-content:space-around; margin-top:20px; font-weight:bold;">
                <div id="detDist"></div>
                <div id="detRate"></div>
            </div>
        </div>
    </div>

    <div id="reviewModal" class="modal-overlay">
        <div class="modal">
            <span onclick="document.getElementById('reviewModal').style.display='none'" style="position:absolute; top:20px; right:20px; cursor:pointer;">‚úï</span>
            <h2 id="revTitle">Reviews</h2>
            <div id="revList" style="text-align:left; max-height:200px; overflow-y:auto; margin-bottom:20px; background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;"></div>
            <input type="hidden" id="revId">
            <input type="number" id="revRate" placeholder="Rating (1-5)" class="input-field" min="1" max="5">
            <textarea id="revText" placeholder="Share your experience..." class="input-field" rows="3"></textarea>
            <button onclick="subRev()" class="action-btn">POST REVIEW</button>
        </div>
    </div>

    <div id="authModal" class="modal-overlay">
        <div class="modal">
            <span onclick="document.getElementById('authModal').style.display='none'" style="position:absolute; top:20px; right:20px; cursor:pointer;">‚úï</span>
            <h2 id="authTitle">Welcome Back</h2>
            <input id="uName" placeholder="Username" class="input-field">
            <input id="uPass" type="password" placeholder="Password" class="input-field">
            <button onclick="doAuth()" id="authActionBtn" class="action-btn">SIGN IN</button>
            <p id="authToggleText" style="margin-top:15px; cursor:pointer; font-size:0.9rem; color:var(--accent);" onclick="toggleAuthMode()">New here? Create an account</p>
        </div>
    </div>

    <script>
        let token = localStorage.getItem("tok");
        let role = localStorage.getItem("role");
        let user = localStorage.getItem("usr");
        let curType = "places"; 
        let isDark = true;
        let isRegister = false; 
        let lat = 0, lon = 0; 

        function init() {
            if(token) {
                document.getElementById('authBtn').innerText = "Logout";
                if(role === 'admin') document.getElementById('adminBtn').style.display = "block";
            }
            // Get Geo & Fetch
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    lat = p.coords.latitude; lon = p.coords.longitude; fetchData(); 
                }, () => fetchData());
            } else { fetchData(); }
        }

        function toggleTheme() {
            isDark = !isDark;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.getElementById('themeBtn').innerText = isDark ? '‚òÄ' : '‚òæ';
        }

        async function fetchData() {
            const city = document.getElementById('cityInput').value;
            document.getElementById('heroCity').innerText = city.toUpperCase();
            
            const fd = new FormData(); 
            fd.append('city', city);
            fd.append('type', curType);
            fd.append('user_lat', lat); 
            fd.append('user_lon', lon); 
            
            try {
                const r = await fetch('/discover_places', {method:'POST', body:fd});
                const d = await r.json();
                
                const g = document.getElementById('grid'); g.innerHTML = '';
                
                if(!d.items || d.items.length === 0) {
                    g.innerHTML = `<p style="text-align:center; width:100%; color:var(--text); opacity:0.6; font-size:1.2rem; margin-top:20px;">
                        No ${curType} found in ${city} yet. <br> 
                        <span style="font-size:0.9rem; color:var(--accent); cursor:pointer;" onclick="openAdd()">+ Be the first to add one!</span>
                    </p>`;
                    return;
                }

                d.items.forEach(i => {
                    if (!i) return; 
                    const safeName = (i.name || "Unknown").replace(/'/g, "\\'");
                    const safeDesc = (i.desc || "").replace(/'/g, "\\'").replace(/"/g, ""); 
                    const safeImg = i.img || "https://placehold.co/600x400/1e293b/ffffff?text=TourBuddy";
                    const safeVibe = i.vibe || "General";
                    const safeDuration = i.duration || "1-2 hrs";
                    const safeBudget = i.budget || "N/A";
                    const safeDist = i.distance || "N/A";
                    const safeRate = i.rating || "New";

                    g.innerHTML += `
                        <div class="card">
                            <div class="vibe-badge">${safeVibe}</div>
                            <img src="${safeImg}" class="card-img" onerror="this.src='https://placehold.co/600x400?text=Image+Error'">
                            <div class="card-body">
                                <h3>${safeName}</h3>
                                <div class="time-badge">‚è≥ ${safeDuration}</div>
                                <div class="time-badge">üí∞ ${safeBudget}</div>
                                <div class="time-badge">üìç ${safeDist}</div>
                                <p style="color:var(--text); opacity:0.7; font-size:0.9rem; margin-top:10px; flex:1;">${safeDesc.substring(0, 80)}...</p>
                                
                                <div class="btn-group">
                                    <button class="btn-sm" onclick="openDetail('${safeName}', '${safeImg}', '${safeDesc}', '${safeDist}', '${safeRate}')">Info</button>
                                    <button class="btn-sm" onclick="openRev('${i.id}', '${safeName}')">Review</button>
                                    <button class="btn-sm btn-nav" onclick="window.open('http://googleusercontent.com/maps.google.com/?q=${i.lat},${i.lon}')">Nav ‚Üó</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                if (typeof VanillaTilt !== 'undefined') VanillaTilt.init(document.querySelectorAll(".card"));
            } catch(e) { console.error(e); }
        }

        function switchTab(type, btn) {
            curType = type;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            fetchData();
        }

        function openDetail(name, img, desc, dist, rate) {
            document.getElementById('detName').innerText = name;
            document.getElementById('detImg').src = img;
            document.getElementById('detDesc').innerText = desc;
            document.getElementById('detDist').innerText = "üìç " + dist;
            document.getElementById('detRate').innerText = "‚≠ê " + rate;
            document.getElementById('detailModal').style.display = 'flex';
        }

        async function openRev(id, name) {
            document.getElementById('revId').value = id;
            document.getElementById('revTitle').innerText = name;
            document.getElementById('reviewModal').style.display = 'flex';
            const fd = new FormData(); fd.append('place_id', id);
            const r = await fetch('/get_reviews', {method:'POST', body:fd});
            const d = await r.json();
            document.getElementById('revList').innerHTML = d.reviews.length ? d.reviews.map(x=>`<div style="margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:5px;"><b>${x.user}</b>: ${x.text} <span style="float:right; color:#fbbf24">${x.rating}‚òÖ</span></div>`).join('') : "No reviews yet.";
        }

        async function subRev() {
            const fd = new FormData();
            fd.append('place_id', document.getElementById('revId').value);
            fd.append('user_name', user || "Guest");
            fd.append('rating', document.getElementById('revRate').value);
            fd.append('review_text', document.getElementById('revText').value);
            await fetch('/submit_review', {method:'POST', body:fd});
            alert("Review Posted!");
            document.getElementById('reviewModal').style.display='none';
        }

        async function generateAI() {
            const name = document.getElementById('aName').value;
            const vibe = document.getElementById('aVibe').value || "Awesome";
            const city = document.getElementById('cityInput').value;
            if(!name) return alert("Enter Name first!");
            const btn = document.querySelector('.ai-btn'); btn.innerText = "ü§ñ Thinking...";
            const fd = new FormData(); fd.append('name', name); fd.append('city', city); fd.append('vibe', vibe);
            try {
                const r = await fetch('/generate_ai_desc', {method:'POST', body:fd});
                const d = await r.json();
                if(d.status === 'success') { document.getElementById('aDesc').value = d.desc; btn.innerText = "‚ú® Done!"; } 
                else { alert(d.desc); btn.innerText = "‚ú® Write with AI"; }
            } catch(e) { alert("AI Error"); }
        }

        async function subPlace() {
            const fd = new FormData();
            fd.append('city', document.getElementById('cityInput').value); 
            fd.append('category_type', document.getElementById('aType').value); 
            fd.append('name', document.getElementById('aName').value); 
            fd.append('vibe', document.getElementById('aVibe').value);
            fd.append('duration', document.getElementById('aTime').value); 
            fd.append('desc', document.getElementById('aDesc').value);
            fd.append('budget', document.getElementById('aBudget').value); 
            fd.append('lat', document.getElementById('aLat').value || 0);
            fd.append('lon', document.getElementById('aLon').value || 0);
            const f = document.getElementById('aFile').files[0]; if(f) fd.append('file', f);
            
            const r = await fetch('/add_place', {method:'POST', body:fd});
            const d = await r.json();
            if(d.status === 'success') { alert("Added!"); document.getElementById('addModal').style.display='none'; fetchData(); } else alert("Error");
        }

        async function findCoords() {
            const name = document.getElementById('aName').value; const city = document.getElementById('cityInput').value;
            const r = await fetch('/geocode', {method:'POST', body:new URLSearchParams({address: name + ", " + city})});
            const d = await r.json();
            if(d.status==='success') { document.getElementById('aLat').value = d.lat; document.getElementById('aLon').value = d.lon; } else alert("Not found");
        }

        // --- AUTH & REGISTER LOGIC ---
        function openAuth() { 
            if(token) { localStorage.clear(); location.reload(); } 
            else document.getElementById('authModal').style.display='flex'; 
        }
        function openAdd() { document.getElementById('addModal').style.display='flex'; }

        function toggleAuthMode() {
            isRegister = !isRegister;
            document.getElementById('authTitle').innerText = isRegister ? "Create Account" : "Welcome Back";
            document.getElementById('authActionBtn').innerText = isRegister ? "REGISTER" : "SIGN IN";
            document.getElementById('authToggleText').innerText = isRegister ? "Already have an account? Sign In" : "New here? Create an account";
        }

        async function doAuth() {
            const u = document.getElementById('uName').value; 
            const p = document.getElementById('uPass').value;
            const endpoint = isRegister ? '/register' : '/login';

            const r = await fetch(endpoint, {
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({username:u, password:p})
            });
            const d = await r.json();
            
            if(d.status === 'success') { 
                if(isRegister) {
                    alert("Account Created! Please Login.");
                    toggleAuthMode(); 
                } else {
                    localStorage.setItem('tok', d.token); 
                    localStorage.setItem('role', d.role); 
                    localStorage.setItem('usr', u); 
                    location.reload(); 
                }
            } else { alert(d.message); }
        }

        init();
    </script>
</body>
</html>