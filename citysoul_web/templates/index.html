<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourBuddy v4.2 (Smart Search)</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { 
            --bg: #020617; --surface: #0f172a; --glass: rgba(30,41,59,0.9);
            --border: 1px solid rgba(255,255,255,0.1); --accent: #2dd4bf;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
        }
        [data-theme="light"] {
            --bg: #f8fafc; --surface: #ffffff; --glass: rgba(255,255,255,0.95);
            --border: 1px solid rgba(0,0,0,0.1); --accent: #0d9488;
            --text-main: #0f172a; --text-muted: #475569;
        }
        body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text-main); margin:0; transition:0.3s; }
        .navbar { position:fixed; top:20px; left:5%; width:90%; background:var(--glass); backdrop-filter:blur(10px); border:var(--border); border-radius:50px; padding:10px 30px; display:flex; justify-content:space-between; align-items:center; z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
        .logo { font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--text-main); } 
        .logo span { color:var(--accent); }
        .nav-btn { background:rgba(128,128,128,0.1); color:var(--text-muted); border:var(--border); padding:8px 15px; border-radius:30px; cursor:pointer; transition:0.2s; }
        .nav-btn:hover { background:var(--accent); color:white; }
        .hero { text-align:center; margin-top:140px; }
        .explore-label { color:var(--accent); font-size:1rem; letter-spacing:4px; font-weight:800; margin-bottom:5px; opacity:1; text-transform:uppercase; }
        .search-box { background:var(--glass); padding:8px; border-radius:50px; display:inline-flex; width:500px; border:var(--border); margin-top:30px; }
        .search-box input { background:transparent; border:none; color:var(--text-main); padding:10px 20px; flex:1; outline:none; font-size:1.1rem; }
        .search-btn { background:var(--accent); color:white; border:none; padding:10px 30px; border-radius:40px; font-weight:bold; cursor:pointer; }
        .container { max-width:1200px; margin:0 auto; padding:40px 5%; }
        .tabs { display:flex; justify-content:center; gap:10px; margin-bottom:30px; flex-wrap:wrap; }
        .tab { padding:8px 20px; border-radius:30px; background:rgba(128,128,128,0.1); border:var(--border); color:var(--text-muted); cursor:pointer; transition:0.3s; }
        .tab.active, .tab:hover { background:var(--surface); border-color:var(--accent); color:var(--accent); box-shadow:0 0 15px rgba(45,212,191,0.2); }
        .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:25px; }
        .card { background:var(--glass); border-radius:20px; overflow:hidden; border:var(--border); transition:0.3s; position:relative; }
        .card:hover { transform:translateY(-5px); border-color:var(--accent); }
        .card-img { width:100%; height:200px; object-fit:cover; background:#333; }
        .card-body { padding:20px; }
        .btn-sm { flex:1; padding:8px; border-radius:10px; border:var(--border); background:transparent; color:var(--text-main); cursor:pointer; font-size:0.8rem; margin-right:5px; }
        .btn-sm:hover { background:var(--accent); color:white; }
        .btn-del { border-color: #ef4444; color:#ef4444; }
        .btn-del:hover { background: #ef4444; color:white; }
        .btn-edit { border-color: #fbbf24; color:#fbbf24; }
        .btn-edit:hover { background: #fbbf24; color:black; }
        .dist-badge { position:absolute; top:15px; right:15px; background:rgba(0,0,0,0.6); color:white; padding:5px 10px; border-radius:15px; font-size:0.8rem; backdrop-filter:blur(5px); }
        #map-view { width:100%; height:400px; border-radius:20px; border:1px solid var(--accent); margin-bottom:30px; display:none; }
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .modal { background:var(--surface); width:90%; max-width:500px; border-radius:30px; padding:30px; text-align:center; border:var(--border); max-height:80vh; overflow-y:auto; color:var(--text-main); position:relative; }
        .close-btn { position:absolute; top:20px; right:20px; font-size:1.5rem; cursor:pointer; color:var(--text-muted); }
        .input-field { width:100%; padding:12px; background:rgba(128,128,128,0.1); border:var(--border); color:var(--text-main); border-radius:10px; margin-top:10px; box-sizing:border-box; outline:none; transition:0.3s; }
        .action-btn { width:100%; padding:12px; margin-top:20px; border-radius:40px; background:var(--accent); color:white; border:none; font-weight:bold; cursor:pointer; transition:0.3s; }
        .rev-list { text-align:left; max-height:200px; overflow-y:auto; margin-bottom:20px; background:rgba(128,128,128,0.05); padding:10px; border-radius:10px; }
        .mini-card { padding: 10px; border: var(--border); margin-bottom: 5px; border-radius: 8px; font-size: 0.9rem; text-align: left; background: rgba(128,128,128,0.05); }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">TOUR<span>BUDDY</span></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="nav-btn" onclick="toggleTheme()" id="themeBtn">‚òÄ</button>
            <div id="weather" style="font-size:0.9rem; font-weight:bold; color:var(--accent)">--¬∞C</div>
            <button class="nav-btn" onclick="toggleMap()">Map</button>
            <button class="nav-btn" id="profileBtn" onclick="openProfile()" style="display:none; border-color:var(--accent); color:var(--accent);">üë§ Profile</button>
            <div id="authBtn" class="nav-btn" onclick="handleAuthClick()">Login</div>
        </div>
    </div>

    <div class="hero">
        <p class="explore-label">EXPLORE</p>
        <h1 id="heroCity">BILASPUR</h1>
        <div class="search-box">
            <input type="text" id="cityInput" value="Bilaspur" placeholder="Search City...">
            <button class="search-btn" onclick="fetchData()">GO</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('places', this)">Places</button>
            <button class="tab" onclick="switchTab('shopping', this)">Shop</button>
            <button class="tab" onclick="switchTab('food', this)">Food</button>
            <button class="tab" onclick="switchTab('hotels', this)">Stays</button>
        </div>
        <div id="map-view"></div>
        <div id="grid" class="grid"></div>
    </div>

    <div class="fab" onclick="openAddModal()" style="position:fixed; bottom:30px; right:30px; width:60px; height:60px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; color:white; cursor:pointer; z-index:1500; box-shadow:0 0 20px rgba(45,212,191,0.3);">+</div>

    <div id="authModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('authModal').style.display='none'">√ó</div>
            <h2 id="authTitle">Welcome Back</h2>
            <input id="uName" placeholder="Username" class="input-field">
            <input id="uPass" type="password" placeholder="Password" class="input-field">
            <button onclick="doAuth()" id="authActionBtn" class="action-btn">SIGN IN</button>
            <p id="authToggleText" style="margin-top:15px; cursor:pointer; font-size:0.9rem;" onclick="toggleAuthMode()">New here? Create an account</p>
        </div>
    </div>

    <div id="addModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('addModal').style.display='none'">√ó</div>
            <h2>Add Spot</h2>
            <input id="aName" placeholder="Name (e.g. Taj Mahal)" class="input-field">
            <input id="aDesc" placeholder="Short Description" class="input-field">
            <input id="aBudget" placeholder="Budget (e.g. $10, Free)" class="input-field">
            
            <div style="display:flex; gap:5px;">
                <input id="aLat" placeholder="Lat" class="input-field" readonly style="opacity:0.7">
                <input id="aLon" placeholder="Lon" class="input-field" readonly style="opacity:0.7">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="doGeo()" style="flex:1; background:var(--surface); border:1px solid var(--accent); color:var(--accent); border-radius:5px; padding:8px; cursor:pointer;">
                    üìç Use My GPS
                </button>
                <button onclick="findCoordsByName()" style="flex:1; background:var(--accent); border:none; color:white; border-radius:5px; padding:8px; cursor:pointer;">
                    üîç Find by Name
                </button>
            </div>

            <select id="aType" class="input-field" style="background:var(--surface);">
                <option value="places">Place</option>
                <option value="food">Food</option>
                <option value="shopping">Shop</option>
                <option value="hotels">Hotel</option>
            </select>
            <p style="text-align:left; font-size:0.8rem; margin-top:10px; color:var(--text-muted);">Upload Image (Optional):</p>
            <input type="file" id="aFile" class="input-field" accept="image/*">
            <button id="btn-add-submit" class="action-btn" onclick="subPlace()">SUBMIT SPOT</button>
        </div>
    </div>

    <div id="editImgModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('editImgModal').style.display='none'">√ó</div>
            <h2>Update Image</h2>
            <p id="editName" style="color:var(--accent); margin-bottom:15px;"></p>
            <input type="hidden" id="editId">
            <input type="file" id="editFile" class="input-field" onchange="readEditFile()">
            <button onclick="submitEditImage()" class="action-btn">UPDATE IMAGE</button>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('profileModal').style.display='none'">√ó</div>
            <h2>My Profile</h2>
            <h4 style="text-align:left; color:var(--accent); margin-top:15px;">My Added Places</h4>
            <div id="myPlacesList" class="rev-list">Loading...</div>
            <h4 style="text-align:left; color:var(--accent); margin-top:15px;">My Reviews</h4>
            <div id="myReviewsList" class="rev-list">Loading...</div>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('detailModal').style.display='none'">√ó</div>
            <h2 id="detName" style="color:var(--accent)"></h2>
            <img id="detImg" style="width:100%; height:200px; object-fit:cover; border-radius:15px; margin:10px 0;">
            <p id="detDesc" style="color:var(--text-muted); line-height:1.6;"></p>
            <div style="display:flex; justify-content:space-around; margin-top:20px; font-weight:bold;">
                <div id="detDist"></div>
                <div id="detRate"></div>
            </div>
        </div>
    </div>

    <div id="reviewModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('reviewModal').style.display='none'">√ó</div>
            <h2 id="revTitle">Reviews</h2>
            <div id="revList" class="rev-list"></div>
            <input type="hidden" id="revId">
            <input type="number" id="revRate" placeholder="Rating (1-5)" class="input-field" min="1" max="5">
            <textarea id="revText" placeholder="Share your experience..." class="input-field" rows="3"></textarea>
            <button onclick="subRev()" class="action-btn">POST REVIEW</button>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        let isDark=true, curCity="Bilaspur", curType="places", lat=0, lon=0;
        let map, markers=[], isRegister=false, editImgData="";
        let token = localStorage.getItem("tok");
        let user = localStorage.getItem("usr");
        let role = localStorage.getItem("role");

        document.addEventListener('DOMContentLoaded', () => {
            ui();
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    p=>{ lat=p.coords.latitude; lon=p.coords.longitude; fetchData(); }, 
                    ()=>fetchData()
                );
            } else { fetchData(); }
        });

        // --- UI LOGIC ---
        function ui(){ 
            const b = document.getElementById('authBtn'); 
            const p = document.getElementById('profileBtn');
            if(token) {
                b.innerText = "Logout"; b.style.color = "var(--accent)";
                p.style.display = "block";
            } else {
                b.innerText = "Login"; b.style.color = "var(--text-muted)";
                p.style.display = "none";
            }
        }

        // --- AUTH ---
        function handleAuthClick(){ if(token){ localStorage.clear(); location.reload(); } else document.getElementById('authModal').style.display='flex'; }
        function toggleAuthMode() {
            isRegister = !isRegister;
            document.getElementById('authTitle').innerText = isRegister ? "Create Account" : "Welcome Back";
            document.getElementById('authActionBtn').innerText = isRegister ? "REGISTER" : "SIGN IN";
            document.getElementById('authToggleText').innerText = isRegister ? "Already have an account? Sign In" : "New here? Create an account";
        }
        async function doAuth(){ 
            const u=document.getElementById('uName').value; const p=document.getElementById('uPass').value;
            const ep = isRegister ? '/register' : '/login';
            try {
                const r = await fetch(ep, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const d = await r.json();
                if(d.status==='success'){ 
                    if(!isRegister) { 
                        localStorage.setItem('tok',d.token); localStorage.setItem('usr',u); localStorage.setItem('role',d.role); 
                        token=d.token; user=u; role=d.role; ui(); document.getElementById('authModal').style.display='none'; fetchData();
                    } else { alert("Created! Please Login."); toggleAuthMode(); } 
                } else alert(d.message); 
            } catch(e) { alert("Error"); }
        }

        // --- NEW: FIND COORDS BY NAME ---
        async function findCoordsByName() {
            const name = document.getElementById('aName').value;
            const city = document.getElementById('cityInput').value;
            const btn = event.target;
            
            if(!name) return alert("Please enter the place Name first!");
            
            btn.innerText = "üîç Searching...";
            try {
                const r = await fetch('/geocode', {
                    method: 'POST',
                    body: new URLSearchParams({ address: `${name}, ${city}` })
                });
                const d = await r.json();
                if(d.status === 'success') {
                    document.getElementById('aLat').value = d.lat;
                    document.getElementById('aLon').value = d.lon;
                    alert(`‚úÖ Found Location: ${name}`);
                    btn.innerText = "‚úÖ Location Set";
                } else {
                    alert("Could not find place. Try 'City Center' or type manually.");
                    btn.innerText = "üîç Find by Name";
                }
            } catch(e) {
                alert("Search Error");
                btn.innerText = "üîç Find by Name";
            }
        }

        function doGeo() {
            navigator.geolocation.getCurrentPosition(p=>{
                document.getElementById('aLat').value = p.coords.latitude;
                document.getElementById('aLon').value = p.coords.longitude;
                alert("‚úÖ Used Your Current GPS!");
            });
        }

        // --- ADD PLACE ---
        function openAddModal(){ document.getElementById('addModal').style.display='flex'; }
        
        async function subPlace() {
            const btn = document.getElementById('btn-add-submit');
            btn.innerText = "‚è≥ Uploading..."; btn.disabled = true;
            const fd = new FormData();
            fd.append('city', curCity); fd.append('category_type', document.getElementById('aType').value);
            fd.append('name', document.getElementById('aName').value); fd.append('desc', document.getElementById('aDesc').value);
            fd.append('budget', document.getElementById('aBudget').value); fd.append('lat', document.getElementById('aLat').value || "0");
            fd.append('lon', document.getElementById('aLon').value || "0"); fd.append('user', user || "Guest");
            const fileInput = document.getElementById('aFile');
            if(fileInput.files[0]) fd.append('file', fileInput.files[0]);

            try {
                const r = await fetch('/add_place', { method: 'POST', body: fd });
                const d = await r.json();
                if(d.status==='success') { alert("‚úÖ Added!"); document.getElementById('addModal').style.display='none'; fetchData(); } 
                else alert("Error: " + d.message);
            } catch(e) { alert("Failed"); }
            btn.innerText = "SUBMIT SPOT"; btn.disabled = false;
        }

        // --- FETCH & RENDER ---
        async function fetchData() {
            const city = document.getElementById('cityInput').value; curCity=city;
            document.getElementById('heroCity').innerText = city.toUpperCase();
            try {
                const fd = new FormData(); fd.append('city', city); fd.append('type', curType);
                fd.append('user_lat', lat); fd.append('user_lon', lon);
                const r = await fetch('/discover_places', {method:'POST', body:fd});
                const d = await r.json();
                render(d.items);
                const wr = await fetch('/get_weather', {method:'POST', body:fd});
                const wd = await wr.json();
                if(wd.status==='success') document.getElementById('weather').innerText = wd.temp + "¬∞C";
            } catch(e) { console.error(e); }
        }

        function render(items) {
            const g = document.getElementById('grid'); g.innerHTML = '';
            if(!map) { map = L.map('map-view').setView([20.59, 78.96], 5); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); }
            markers.forEach(m => map.removeLayer(m)); markers = [];

            if(!items || items.length===0) { g.innerHTML='<div style="color:var(--text-muted)">No spots found.</div>'; return; }
            
            items.forEach((i) => {
                if(i.lat && i.lon && i.lat!==0) { markers.push(L.marker([i.lat, i.lon]).addTo(map).bindPopup(`<b>${i.name}</b>`)); }
                
                let adminControls = "";
                if(role === "admin") {
                    adminControls = `<button class="btn-sm btn-edit" onclick="openEditImage('${i.id}', '${i.name}')">‚úèÔ∏è</button>
                                     <button class="btn-sm btn-del" onclick="deleteItem('${i.id}')">üóëÔ∏è</button>`;
                }

                const d = document.createElement('div'); d.className='card';
                d.innerHTML = `
                    ${i.distance !== "N/A" ? `<div class="dist-badge">üìç ${i.distance}</div>` : ''}
                    <img src="${i.img}" class="card-img" loading="lazy">
                    <div class="card-body">
                        <h3>${i.name}</h3>
                        <p style="color:var(--accent)">${i.budget}</p>
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button class="btn-sm" onclick="openDetailModal('${i.id}', '${i.name}', '${i.img}', '${i.desc}', '${i.distance}', '${i.rating}')">Info</button>
                            <button class="btn-sm" onclick="openRev('${i.id}', '${i.name}')">Review</button>
                            ${adminControls}
                        </div>
                    </div>`;
                g.appendChild(d);
            });
            if(markers.length > 0) { map.fitBounds(new L.featureGroup(markers).getBounds().pad(0.2)); }
            VanillaTilt.init(document.querySelectorAll(".card"));
        }

        // --- UTILS ---
        async function deleteItem(id) { if(!confirm("Delete?")) return; const fd=new FormData(); fd.append('id',id); fd.append('token',token); await fetch('/admin_delete',{method:'POST',body:fd}); fetchData(); openProfile(); }
        async function openProfile() { if(!user) return; document.getElementById('profileModal').style.display='flex'; const fd=new FormData(); fd.append('username',user); const r=await fetch('/get_user_profile',{method:'POST',body:fd}); const d=await r.json(); document.getElementById('myPlacesList').innerHTML = d.places.map(x=>`<div class="mini-card"><b>${x.name}</b> <span style="float:right;cursor:pointer;" onclick="deleteItem('${x.id}')">üóëÔ∏è</span></div>`).join(''); document.getElementById('myReviewsList').innerHTML = d.reviews.map(x=>`<div class="mini-card"><b>${x.rating}‚≠ê</b>: ${x.text}</div>`).join(''); }
        function openEditImage(id, name) { document.getElementById('editId').value = id; document.getElementById('editName').innerText = "Edit: " + name; document.getElementById('editImgModal').style.display = 'flex'; }
        function readEditFile() { const f = document.getElementById('editFile').files[0]; const r = new FileReader(); r.onload = () => editImgData = r.result; if(f) r.readAsDataURL(f); }
        async function submitEditImage() { const id=document.getElementById('editId').value; if(!editImgData) return alert("Select image"); const fd=new FormData(); fd.append('id',id); fd.append('img_url',editImgData); fd.append('token',token); await fetch('/admin_update_image',{method:'POST',body:fd}); document.getElementById('editImgModal').style.display='none'; fetchData(); }
        function openDetailModal(id, name, img, desc, dist, rate) { document.getElementById('detName').innerText=name; document.getElementById('detImg').src=img; document.getElementById('detDesc').innerText=desc; document.getElementById('detDist').innerText="üìç "+dist; document.getElementById('detRate').innerText="‚≠ê "+rate; document.getElementById('detailModal').style.display='flex'; }
        async function openRev(id, name) { document.getElementById('revId').value=id; document.getElementById('revTitle').innerText=name; document.getElementById('reviewModal').style.display='flex'; const fd=new FormData(); fd.append('place_id',id); const r=await fetch('/get_reviews',{method:'POST',body:fd}); const d=await r.json(); document.getElementById('revList').innerHTML=d.reviews.map(x=>`<div class="mini-card"><b>${x.user}</b>: ${x.text}</div>`).join(''); }
        async function subRev() { const fd=new FormData(); fd.append('place_id',document.getElementById('revId').value); fd.append('user_name',user||"Guest"); fd.append('rating',document.getElementById('revRate').value); fd.append('review_text',document.getElementById('revText').value); await fetch('/submit_review',{method:'POST',body:fd}); document.getElementById('reviewModal').style.display='none'; }
        function toggleTheme() { isDark=!isDark; document.documentElement.setAttribute('data-theme',isDark?'dark':'light'); document.getElementById('themeBtn').innerText=isDark?'‚òÄ':'‚òæ'; }
        function toggleMap() { const m=document.getElementById('map-view'); m.style.display=m.style.display==='none'?'block':'none'; if(map) map.invalidateSize(); }
        function switchTab(t,b){ curType=t; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); fetchData(); }
        function closeM(e){ if(e.target.className.includes('modal-overlay')||e.target.className.includes('close-btn')) e.target.closest('.modal-overlay').style.display='none'; }
    </script>
</body>
</html>