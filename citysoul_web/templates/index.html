<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourBuddy</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <style>
        :root { 
            --bg: #020617; --surface: #0f172a; --glass: rgba(30,41,59,0.9);
            --border: 1px solid rgba(255,255,255,0.1); --accent: #2dd4bf;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
        }
        [data-theme="light"] {
            --bg: #f8fafc; --surface: #ffffff; --glass: rgba(255,255,255,0.95);
            --border: 1px solid rgba(0,0,0,0.1); --accent: #0d9488;
            --text-main: #0f172a; --text-muted: #475569;
        }
        body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text-main); margin:0; transition:0.3s; }
        
        .navbar { position:fixed; top:20px; left:5%; width:90%; background:var(--glass); backdrop-filter:blur(10px); border:var(--border); border-radius:50px; padding:10px 30px; display:flex; justify-content:space-between; align-items:center; z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
        .logo { font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--text-main); } 
        .logo span { color:var(--accent); }
        .nav-btn { background:rgba(128,128,128,0.1); color:var(--text-muted); border:var(--border); padding:8px 15px; border-radius:30px; cursor:pointer; transition:0.2s; }
        .nav-btn:hover { background:var(--accent); color:white; }

        .hero { text-align:center; margin-top:140px; }
        .explore-label { color:var(--accent); font-size:1rem; letter-spacing:4px; font-weight:800; margin-bottom:5px; opacity:1; text-transform:uppercase; }
        
        .search-box { background:var(--glass); padding:8px; border-radius:50px; display:inline-flex; width:500px; border:var(--border); margin-top:30px; }
        .search-box input { background:transparent; border:none; color:var(--text-main); padding:10px 20px; flex:1; outline:none; font-size:1.1rem; }
        .search-btn { background:var(--accent); color:white; border:none; padding:10px 30px; border-radius:40px; font-weight:bold; cursor:pointer; }

        .container { max-width:1200px; margin:0 auto; padding:40px 5%; }
        .tabs { display:flex; justify-content:center; gap:10px; margin-bottom:30px; flex-wrap:wrap; }
        .tab { padding:8px 20px; border-radius:30px; background:rgba(128,128,128,0.1); border:var(--border); color:var(--text-muted); cursor:pointer; transition:0.3s; }
        .tab.active, .tab:hover { background:var(--surface); border-color:var(--accent); color:var(--accent); box-shadow:0 0 15px rgba(45,212,191,0.2); }

        .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:25px; }
        .card { background:var(--glass); border-radius:20px; overflow:hidden; border:var(--border); transition:0.3s; position:relative; }
        .card:hover { transform:translateY(-5px); border-color:var(--accent); }
        .card-img { width:100%; height:200px; object-fit:cover; background:#333; }
        .card-body { padding:20px; }
        .btn-sm { flex:1; padding:8px; border-radius:10px; border:var(--border); background:transparent; color:var(--text-main); cursor:pointer; font-size:0.8rem; margin-right:5px; }
        .btn-sm:hover { background:var(--accent); color:white; }
        .btn-del { border-color: #ef4444; color:#ef4444; }
        .btn-del:hover { background: #ef4444; }
        .btn-edit { border-color: #fbbf24; color:#fbbf24; }
        .btn-edit:hover { background: #fbbf24; color:black; }
        
        .dist-badge { position:absolute; top:15px; right:15px; background:rgba(0,0,0,0.6); color:white; padding:5px 10px; border-radius:15px; font-size:0.8rem; backdrop-filter:blur(5px); }

        #map-view { width:100%; height:400px; border-radius:20px; border:1px solid var(--accent); margin-bottom:30px; display:none; }
        
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .modal { background:var(--surface); width:90%; max-width:500px; border-radius:30px; padding:30px; text-align:center; border:var(--border); max-height:80vh; overflow-y:auto; color:var(--text-main); position:relative; }
        .close-btn { position:absolute; top:20px; right:20px; font-size:1.5rem; cursor:pointer; color:var(--text-muted); }
        .close-btn:hover { color:var(--accent); }
        
        .input-field { width:100%; padding:12px; background:rgba(128,128,128,0.1); border:var(--border); color:var(--text-main); border-radius:10px; margin-top:10px; box-sizing:border-box; outline:none; transition:0.3s; }
        .input-field:focus { border-color:var(--accent); background:rgba(45,212,191,0.05); }
        .action-btn { width:100%; padding:12px; margin-top:20px; border-radius:40px; background:var(--accent); color:white; border:none; font-weight:bold; cursor:pointer; transition:0.3s; }
        .action-btn:hover { opacity:0.9; transform:scale(1.02); }

        .auth-header { margin-bottom:20px; }
        .auth-header h2 { font-size:2rem; margin:0; color:var(--accent); font-family:'Playfair Display',serif; }
        .auth-header p { color:var(--text-muted); font-size:0.9rem; margin-top:5px; }
        .auth-toggle { margin-top:20px; font-size:0.9rem; color:var(--text-muted); }
        .auth-toggle span { color:var(--accent); cursor:pointer; font-weight:600; text-decoration:underline; }
        
        .rev-list { text-align:left; max-height:200px; overflow-y:auto; margin-bottom:20px; background:rgba(128,128,128,0.05); padding:10px; border-radius:10px; }
        .rev-item { border-bottom:1px solid var(--border); padding:8px 0; font-size:0.9rem; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo">TOUR<span>BUDDY</span></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="nav-btn" onclick="toggleTheme()" id="themeBtn">‚òÄ</button>
            <div id="weather" style="font-size:0.9rem; font-weight:bold; color:var(--accent)">--¬∞C</div>
            <button class="nav-btn" onclick="toggleMap()">Map</button>
            <button class="nav-btn" onclick="openRouteModal()">Route</button>
            <div id="authBtn" class="nav-btn" onclick="handleAuthClick()">Login</div>
        </div>
    </div>

    <div class="hero">
        <p class="explore-label">EXPLORE</p>
        <h1 id="heroCity">BILASPUR</h1>
        <div class="search-box">
            <input type="text" id="cityInput" value="Bilaspur" placeholder="Search City...">
            <button class="search-btn" onclick="fetchData()">GO</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('places', this)">Places</button>
            <button class="tab" onclick="switchTab('shopping', this)">Shop</button>
            <button class="tab" onclick="switchTab('food', this)">Food</button>
            <button class="tab" onclick="switchTab('hotels', this)">Stays</button>
        </div>
        <div id="map-view"></div>
        <div id="grid" class="grid"></div>
    </div>

    <div class="fab" onclick="openAddModal()" style="position:fixed; bottom:30px; right:30px; width:60px; height:60px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; color:white; cursor:pointer; z-index:1500; box-shadow:0 0 20px rgba(45,212,191,0.3);">+</div>

    <div id="editImgModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('editImgModal').style.display='none'">√ó</div>
            <h2>Update Image</h2>
            <input type="hidden" id="editId">
            <p id="editName" style="color:var(--accent); margin-bottom:15px;"></p>
            <input type="file" id="editFile" class="input-field" onchange="readEditFile()">
            <button id="subBtn" onclick="subPlace()" class="action-btn">SUBMIT</button>
        </div>
    </div>

    <div id="authModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('authModal').style.display='none'">√ó</div>
            <div class="auth-header">
                <h2 id="authTitle">Welcome Back</h2>
                <p id="authSubtitle">Please sign in to continue</p>
            </div>
            <input id="uName" placeholder="Username" class="input-field">
            <input id="uPass" type="password" placeholder="Password" class="input-field" onkeypress="if(event.key==='Enter') doAuth()">
            <button onclick="doAuth()" id="authActionBtn" class="action-btn">SIGN IN</button>
            <div class="auth-toggle">
                <span id="authToggleText" onclick="toggleAuthMode()">New here? Create an account</span>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('addModal').style.display='none'">√ó</div>
            <h2>Add Spot</h2>
            <input id="aName" placeholder="Name" class="input-field">
            <input id="aAddr" placeholder="Address" class="input-field">
            <button onclick="doGeo()" style="margin-top:5px; background:var(--accent); border:none; border-radius:5px; padding:5px; color:white;">Find GPS</button>
            <input type="hidden" id="aLat"><input type="hidden" id="aLon">
            <select id="aType" class="input-field" style="background:#0f172a;">
                <option value="places">Place</option>
                <option value="food">Food</option>
                <option value="shopping">Shop</option>
                <option value="hotels">Hotel</option>
            </select>
            <input type="file" id="aFile" class="input-field" onchange="readF()">
            <button id="subBtn" onclick="subPlace()" class="action-btn">SUBMIT</button>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('detailModal').style.display='none'">√ó</div>
            <h2 id="detName" style="color:var(--accent)"></h2>
            <img id="detImg" style="width:100%; height:200px; object-fit:cover; border-radius:15px; margin:10px 0;">
            <p id="detDesc" style="color:var(--text-muted); margin-top:10px; line-height:1.6;"></p>
            <div style="display:flex; justify-content:space-around; margin-top:20px; font-weight:bold;">
                <div id="detDist" style="color:var(--accent)">üìç -- km</div>
                <div id="detRate" style="color:#fbbf24">‚≠ê --</div>
            </div>
            <button id="detNavBtn" class="action-btn">Navigate Here</button>
        </div>
    </div>

    <div id="reviewModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('reviewModal').style.display='none'">√ó</div>
            <h2 id="revTitle" style="color:var(--accent)">Reviews</h2>
            <div id="revList" class="rev-list">Loading...</div>
            <input type="hidden" id="revId">
            <input id="revName" placeholder="Your Name" class="input-field">
            <input type="number" id="revRate" placeholder="Rating (1-5)" class="input-field" min="1" max="5">
            <textarea id="revText" placeholder="Share your experience..." class="input-field" rows="3"></textarea>
            <button onclick="subRev()" class="action-btn">POST REVIEW</button>
        </div>
    </div>

    <div id="routeModal" class="modal-overlay" onclick="closeM(event)">
        <div class="modal">
            <div class="close-btn" onclick="document.getElementById('routeModal').style.display='none'">√ó</div>
            <h2>Route</h2>
            <button onclick="getLoc()" class="input-field" style="text-align:left;">üìç Use My Location</button>
            <input id="rDest" placeholder="Destination" class="input-field">
            <button onclick="calcRoute()" class="action-btn">GO</button>
        </div>
    </div>

    <script>
        let isDark = true;
        function toggleTheme() {
            isDark = !isDark;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.getElementById('themeBtn').innerText = isDark ? '‚òÄ' : '‚òæ';
        }

        let curCity="Bilaspur", curType="places", token=localStorage.getItem("tok"), user=localStorage.getItem("usr"), userRole=localStorage.getItem("role"), lat=0, lon=0, map, routePolyline, upImg="", editImg="", isRegister=false, currentItems=[];

        function ui(){ const b=document.getElementById('authBtn'); b.innerText = token ? user : "Login"; if(token) b.style.color = "var(--accent)"; } ui();

        navigator.geolocation.getCurrentPosition(p=>{ lat=p.coords.latitude; lon=p.coords.longitude; fetchData(); }, ()=>fetchData());

        async function fetchData() {
            const city = document.getElementById('cityInput').value; curCity=city;
            document.getElementById('heroCity').innerText = city.toUpperCase();
            
            Promise.all([
                fetch('/get_weather', {method:'POST', body:new URLSearchParams({city:city})}).then(r=>r.json()),
                fetch('/discover_places', {method:'POST', body:new URLSearchParams({city:city, type:curType, user_lat:lat, user_lon:lon})}).then(r=>r.json())
            ]).then(([w, d]) => {
                if(w.status==='success') document.getElementById('weather').innerText = `${w.temp}¬∞C`;
                render(d.items);
            });
        }

        function render(items) {
            currentItems = items;
            const g = document.getElementById('grid'); g.innerHTML = '';
            if(!items || items.length===0) { g.innerHTML='<div style="color:var(--text-muted)">No spots found.</div>'; return; }
            items.forEach((i) => {
                const distBadge = i.distance !== "N/A" ? `<div class="dist-badge">üìç ${i.distance}</div>` : '';
                
                let adminControls = "";
                if(userRole === "admin") {
                    adminControls = `<button class="btn-sm btn-edit" onclick="openEditImage('${i.id}', '${i.name}')">‚úèÔ∏è</button>
                                     <button class="btn-sm btn-del" onclick="deleteItem('${i.id}')">üóëÔ∏è</button>`;
                }

                const d = document.createElement('div'); d.className='card';
                d.innerHTML = `
                    ${distBadge}
                    <img src="${i.img}" class="card-img" loading="lazy">
                    <div class="card-body">
                        <h3>${i.name}</h3>
                        <p>${i.category}</p>
                        <div class="btn-group" style="display:flex; gap:5px;">
                            <button class="btn-sm" onclick="openDetailModal('${i.id}')">Info</button>
                            <button class="btn-sm" onclick="openReviewModal('${i.id}', '${i.name}')">Review</button>
                            <button class="btn-sm" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${i.lat},${i.lon}')">Nav</button>
                            ${adminControls}
                        </div>
                    </div>`;
                g.appendChild(d);
            });
            VanillaTilt.init(document.querySelectorAll(".card"));
        }

        // --- ADMIN IMAGE EDIT ---
        function openEditImage(id, name) {
            document.getElementById('editId').value = id;
            document.getElementById('editName').innerText = "Editing: " + name;
            document.getElementById('editImgModal').style.display = 'flex';
        }
        function readEditFile() { const f=document.getElementById('editFile').files[0], r=new FileReader(); r.onload=()=>editImg=r.result; if(f)r.readAsDataURL(f); }
        async function submitEditImage() {
            const id = document.getElementById('editId').value;
            if(!editImg) return alert("Select an image!");
            await fetch('/admin_update_image', {method:'POST', body:new URLSearchParams({city:curCity, category:curType, id:id, img_url:editImg, token:token})});
            alert("Image Updated!");
            document.getElementById('editImgModal').style.display='none';
            fetchData();
        }

        // --- AUTH ---
        function toggleAuthMode() {
            isRegister = !isRegister;
            const title = document.getElementById('authTitle');
            const sub = document.getElementById('authSubtitle');
            const btn = document.getElementById('authActionBtn');
            const toggle = document.getElementById('authToggleText');
            if (isRegister) { title.innerText = "Create Account"; sub.innerText = "Join the community today"; btn.innerText = "REGISTER"; toggle.innerHTML = "Already have an account? <span style='color:var(--accent); text-decoration:underline;'>Sign In</span>"; } 
            else { title.innerText = "Welcome Back"; sub.innerText = "Please sign in to continue"; btn.innerText = "SIGN IN"; toggle.innerHTML = "New here? <span style='color:var(--accent); text-decoration:underline;'>Create an account</span>"; }
        }
        function handleAuthClick(){ if(token){localStorage.clear();location.reload();}else document.getElementById('authModal').style.display='flex'; }
        
        async function doAuth(){ 
            const u=document.getElementById('uName').value.trim();
            const p=document.getElementById('uPass').value.trim();
            const endpoint = isRegister ? '/register' : '/login';
            
            // USE JSON REQUEST (Avoids python-multipart crash for login)
            const r = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, password: p })
            });
            const d = await r.json();
            
            if(d.status==='success'){ if(!isRegister) { localStorage.setItem('tok',d.token);localStorage.setItem('usr',u);localStorage.setItem('role',d.role); token=d.token;user=u;userRole=d.role; ui(); if(d.role==="admin")alert("Admin Mode Active"); } else { alert("Created! Login now."); toggleAuthMode(); return; } document.getElementById('authModal').style.display='none'; fetchData(); } else alert(d.message); 
        }
        async function deleteItem(id) { if(confirm("Admin: Delete this place?")) { await fetch('/admin_delete', {method:'POST', body:new URLSearchParams({city:curCity, category:curType, id:id, token:token})}); fetchData(); } }

        function openDetailModal(id) { const item = currentItems.find(x => x.id === id); if(!item) return; document.getElementById('detName').innerText = item.name; document.getElementById('detImg').src = item.img; document.getElementById('detDesc').innerText = item.desc || "No description."; document.getElementById('detDist').innerText = "üìç " + item.distance; document.getElementById('detRate').innerText = "‚≠ê " + item.rating; document.getElementById('detNavBtn').onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lon}`); document.getElementById('detailModal').style.display = 'flex'; }
        async function openReviewModal(id, name) { document.getElementById('revId').value = id; document.getElementById('revTitle').innerText = name; document.getElementById('reviewModal').style.display = 'flex'; if(user) document.getElementById('revName').value = user; loadReviews(id); }
        async function loadReviews(id) { const r = await fetch('/get_reviews', {method:'POST', body:new URLSearchParams({place_id:id})}); const d = await r.json(); const list = document.getElementById('revList'); if(d.reviews.length === 0) list.innerHTML = "<div style='color:#aaa'>No reviews yet.</div>"; else list.innerHTML = d.reviews.map(x => `<div class="rev-item"><div style="display:flex;justify-content:space-between;color:var(--accent)"><b>${x.user}</b> <span>${x.rating}‚òÖ</span></div><div style="color:var(--text-muted);font-size:0.8rem">${x.date}</div><p>${x.text}</p></div>`).join(''); }
        async function subRev() { const id = document.getElementById('revId').value; const u = document.getElementById('revName').value || "Guest"; const r = document.getElementById('revRate').value; const t = document.getElementById('revText').value; await fetch('/submit_review', {method:'POST', body:new URLSearchParams({place_id:id, user_name:u, rating:r, review_text:t})}); alert("Review Posted!"); loadReviews(id); fetchData(); }
     async function subPlace(){ 
    const btn = document.getElementById('subBtn'); // Now this will work!
    const name = document.getElementById('aName').value;
    const type = document.getElementById('aType').value;
    
    if(!name) return alert("Please enter a name");
    
    // Visual Feedback
    if(btn) {
        btn.disabled = true;
        btn.innerText = "‚è≥ SAVING...";
    }

    try {
        // 1. Try to find location (with fallback if it fails)
        let finalLat = 0, finalLon = 0;
        try {
            console.log("Attempting geocode...");
            const geoRes = await fetch('/geocode', {
                method:'POST', 
                body:new URLSearchParams({address: name + ", " + curCity})
            });
            const geoData = await geoRes.json();
            if(geoData.status === 'success') {
                finalLat = geoData.lat;
                finalLon = geoData.lon;
            }
        } catch(e) {
            console.log("Geocode failed, using default location.");
        }

        // 2. Send to Database
        console.log("Sending to server...");
        const response = await fetch('/add_place', {
            method: 'POST',
            body: new URLSearchParams({
                city: curCity,
                category_type: type,
                name: name,
                desc: "User Added via Web",
                img_url: upImg || "", 
                budget: "N/A",
                lat: finalLat,
                lon: finalLon,
                user: user || "Guest"
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert("‚úÖ Success: Place Added!");
            document.getElementById('addModal').style.display='none'; 
            fetchData(); // Refresh the grid
        } else {
            alert("‚ùå Server Error: " + data.message);
        }

    } catch (error) {
        alert("‚ùå Error: " + error.message);
        console.error(error);
    } finally {
        if(btn) {
            btn.disabled = false;
            btn.innerText = "SUBMIT";
        }
    }
}
        function toggleMap(){ const m=document.getElementById('map-view'); m.style.display=m.style.display==='none'?'block':'none'; if(m.style.display==='block'){if(!map){map=L.map('map-view').setView([22.07,82.14],10);L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);} setTimeout(()=>map.invalidateSize(),100);}}
        function openRouteModal(){ document.getElementById('routeModal').style.display='flex'; }
        function getLoc(){ navigator.geolocation.getCurrentPosition(p=>{lat=p.coords.latitude;lon=p.coords.longitude;alert('Found');}); }
        async function calcRoute(){ const r=await fetch('/plan_route',{method:'POST',body:new URLSearchParams({user_lat:lat,user_lon:lon,dest_city:document.getElementById('rDest').value})}); const d=await r.json(); document.getElementById('routeModal').style.display='none'; document.getElementById('map-view').style.display='block'; if(!map){ map=L.map('map-view'); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map); } setTimeout(()=>map.invalidateSize(),100); if(routePolyline) map.removeLayer(routePolyline); const pts = d.route.map(p=>[p.lat, p.lon]); routePolyline = L.polyline(pts, {color: '#2dd4bf'}).addTo(map); map.fitBounds(routePolyline.getBounds()); d.route.forEach(p => L.marker([p.lat, p.lon]).addTo(map).bindPopup(p.name)); }
        function switchTab(t,b){ curType=t; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); fetchData(); }
        function openAddModal(){ document.getElementById('addModal').style.display='flex'; }
        function readF(){ const f=document.getElementById('aFile').files[0], r=new FileReader(); r.onload=()=>upImg=r.result; if(f)r.readAsDataURL(f); }
        function closeM(e){ if(e.target.className==='modal-overlay'||e.target.className==='close-btn')e.target.closest('.modal-overlay').style.display='none'; }
    </script>
</body>
</html>