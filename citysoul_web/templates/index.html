<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourBuddy AI v6.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>
    <style>
        :root { --bg:#020617; --surface:#0f172a; --accent:#2dd4bf; --text:#f1f5f9; }
        body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text); margin:0; }
        .navbar { position:fixed; top:20px; left:5%; width:90%; background:rgba(30,41,59,0.9); backdrop-filter:blur(10px); border-radius:50px; padding:10px 30px; display:flex; justify-content:space-between; align-items:center; z-index:1000; }
        .logo { font-size:1.5rem; font-weight:800; } .logo span { color:var(--accent); }
        .nav-btn { background:rgba(128,128,128,0.1); color:#94a3b8; padding:8px 15px; border-radius:30px; cursor:pointer; border:none; text-decoration:none; }
        .nav-btn:hover { background:var(--accent); color:white; }
        .hero { text-align:center; margin-top:140px; }
        .search-box { background:rgba(30,41,59,0.9); padding:8px; border-radius:50px; display:inline-flex; width:500px; margin-top:30px; border:1px solid #334155; }
        .search-box input { background:transparent; border:none; color:white; padding:10px 20px; flex:1; outline:none; font-size:1.1rem; }
        .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:25px; padding:40px 5%; max-width:1200px; margin:0 auto; }
        .card { background:var(--surface); border-radius:20px; overflow:hidden; border:1px solid #334155; position:relative; }
        .card-img { width:100%; height:200px; object-fit:cover; }
        .card-body { padding:20px; }
        .vibe-badge { position:absolute; top:15px; left:15px; background:var(--accent); color:#000; padding:5px 12px; border-radius:15px; font-size:0.8rem; font-weight:bold; }
        .time-badge { display:inline-block; background:#334155; color:#cbd5e1; padding:2px 8px; border-radius:4px; font-size:0.8rem; margin-top:5px; }
        
        /* Modal & Form */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; justify-content:center; align-items:center; }
        .modal { background:var(--surface); width:90%; max-width:500px; padding:30px; border-radius:30px; border:1px solid #334155; position:relative; max-height:90vh; overflow-y:auto; }
        .input-field { width:100%; padding:12px; background:rgba(128,128,128,0.1); border:1px solid #334155; color:white; border-radius:10px; margin-top:10px; box-sizing:border-box; }
        .ai-btn { background:linear-gradient(45deg, #a78bfa, #2dd4bf); color:black; border:none; padding:5px 10px; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:bold; margin-top:5px; float:right; }
        .action-btn { width:100%; padding:12px; margin-top:20px; border-radius:40px; background:var(--accent); color:white; border:none; font-weight:bold; cursor:pointer; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo">TOUR<span>BUDDY</span></div>
        <div style="display:flex; gap:10px;">
            <a href="/admin" id="adminBtn" class="nav-btn" style="display:none; color:#f87171;">üõ°Ô∏è Admin</a>
            <div id="authBtn" class="nav-btn" onclick="openAuth()">Login</div>
        </div>
    </div>

    <div class="hero">
        <h1 id="heroCity">BILASPUR</h1>
        <div class="search-box">
            <input type="text" id="cityInput" value="Bilaspur">
            <button class="nav-btn" style="background:var(--accent); color:black;" onclick="fetchData()">GO</button>
        </div>
    </div>

    <div class="grid" id="grid"></div>

    <div onclick="openAdd()" style="position:fixed; bottom:30px; right:30px; width:60px; height:60px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; color:black; cursor:pointer; z-index:1500; font-weight:bold;">+</div>

    <div id="addModal" class="modal-overlay">
        <div class="modal">
            <span onclick="document.getElementById('addModal').style.display='none'" style="position:absolute; top:20px; right:20px; cursor:pointer;">‚úï</span>
            <h2>Add Spot üåç</h2>
            
            <input id="aName" placeholder="Name (e.g. Taj Mahal)" class="input-field">
            
            <div style="display:flex; gap:10px;">
                <input id="aVibe" placeholder="Vibe (e.g. Spiritual, Chill)" class="input-field">
                <input id="aTime" placeholder="Avg Time (e.g. 2 hrs)" class="input-field">
            </div>

            <div style="margin-top:10px;">
                <label style="color:#94a3b8; font-size:0.9rem;">Description</label>
                <button class="ai-btn" onclick="generateAI()">‚ú® Write with AI</button>
                <textarea id="aDesc" rows="3" class="input-field" placeholder="Or type manually..."></textarea>
            </div>

            <input id="aBudget" placeholder="Budget (e.g. $10)" class="input-field">
            <div style="display:flex; gap:5px;">
                <button onclick="findCoords()" class="input-field" style="background:#334155; cursor:pointer;">üìç Find GPS</button>
                <input id="aLat" placeholder="Lat" class="input-field" style="width:30%">
                <input id="aLon" placeholder="Lon" class="input-field" style="width:30%">
            </div>

            <input type="file" id="aFile" class="input-field">
            <button onclick="subPlace()" class="action-btn">SUBMIT SPOT</button>
        </div>
    </div>

    <div id="authModal" class="modal-overlay">
        <div class="modal">
            <h2>Login</h2>
            <input id="uName" placeholder="Username" class="input-field">
            <input id="uPass" type="password" placeholder="Password" class="input-field">
            <button onclick="doLogin()" class="action-btn">LOGIN</button>
        </div>
    </div>

    <script>
        let token = localStorage.getItem("tok");
        let role = localStorage.getItem("role");
        
        function init() {
            if(token) {
                document.getElementById('authBtn').innerText = "Logout";
                if(role === 'admin') document.getElementById('adminBtn').style.display = "block";
            }
            fetchData();
        }

        async function fetchData() {
            const city = document.getElementById('cityInput').value;
            document.getElementById('heroCity').innerText = city.toUpperCase();
            const fd = new FormData(); fd.append('city', city);
            const r = await fetch('/discover_places', {method:'POST', body:fd});
            const d = await r.json();
            
            const g = document.getElementById('grid'); g.innerHTML = '';
            d.items.forEach(i => {
                g.innerHTML += `
                    <div class="card">
                        <div class="vibe-badge">${i.vibe || 'General'}</div>
                        <img src="${i.img}" class="card-img">
                        <div class="card-body">
                            <h3>${i.name}</h3>
                            <div class="time-badge">‚è≥ ${i.duration || '1-2 hrs'}</div>
                            <div class="time-badge">üí∞ ${i.budget}</div>
                            <p style="color:#94a3b8; font-size:0.9rem; margin-top:10px;">${i.desc}</p>
                        </div>
                    </div>
                `;
            });
            VanillaTilt.init(document.querySelectorAll(".card"));
        }

        // AI GENERATOR FUNCTION ü§ñ
        async function generateAI() {
            const name = document.getElementById('aName').value;
            const vibe = document.getElementById('aVibe').value || "Awesome";
            const city = document.getElementById('cityInput').value;
            
            if(!name) return alert("Enter Name first!");
            const btn = document.querySelector('.ai-btn');
            btn.innerText = "ü§ñ Thinking...";
            
            const fd = new FormData(); fd.append('name', name); fd.append('city', city); fd.append('vibe', vibe);
            try {
                const r = await fetch('/generate_ai_desc', {method:'POST', body:fd});
                const d = await r.json();
                if(d.status === 'success') {
                    document.getElementById('aDesc').value = d.desc;
                    btn.innerText = "‚ú® Done!";
                } else { alert(d.desc); btn.innerText = "‚ú® Write with AI"; }
            } catch(e) { alert("AI Error"); }
        }

        async function subPlace() {
            const fd = new FormData();
            fd.append('city', document.getElementById('cityInput').value);
            fd.append('category_type', 'places');
            fd.append('name', document.getElementById('aName').value);
            fd.append('vibe', document.getElementById('aVibe').value); // New
            fd.append('duration', document.getElementById('aTime').value); // New
            fd.append('desc', document.getElementById('aDesc').value);
            fd.append('budget', document.getElementById('aBudget').value);
            fd.append('lat', document.getElementById('aLat').value || 0);
            fd.append('lon', document.getElementById('aLon').value || 0);
            const f = document.getElementById('aFile').files[0];
            if(f) fd.append('file', f);

            const r = await fetch('/add_place', {method:'POST', body:fd});
            const d = await r.json();
            if(d.status === 'success') {
                alert("Added!"); document.getElementById('addModal').style.display='none'; fetchData();
            } else alert("Error");
        }

        async function findCoords() {
            const name = document.getElementById('aName').value;
            const city = document.getElementById('cityInput').value;
            const r = await fetch('/geocode', {method:'POST', body:new URLSearchParams({address: name + ", " + city})});
            const d = await r.json();
            if(d.status==='success') {
                document.getElementById('aLat').value = d.lat; document.getElementById('aLon').value = d.lon;
            } else alert("Not found");
        }

        function openAuth() { if(token) { localStorage.clear(); location.reload(); } else document.getElementById('authModal').style.display='flex'; }
        function openAdd() { document.getElementById('addModal').style.display='flex'; }
        async function doLogin() {
            const u = document.getElementById('uName').value;
            const p = document.getElementById('uPass').value;
            const r = await fetch('/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})});
            const d = await r.json();
            if(d.status === 'success') {
                localStorage.setItem('tok', d.token); localStorage.setItem('role', d.role);
                location.reload();
            } else alert("Invalid");
        }

        init();
    </script>
</body>
</html>